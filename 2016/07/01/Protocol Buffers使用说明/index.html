<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>No title | Atypical programmer | 做一个非典型程序员</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="">
  <meta name="description" content="Protocol Buffers简介Protocol Buffers是一种数据交换格式，用于结构化数据的读写，类似于序列化机制。在线客服系统里面Message的body部分其实就是具有结构化的数据，因此可以采用Protocol Buffers来实现各平台和语言之间的消息传输。Protocol Buffers特点以及与XML、各语言的序列化机制等的比较，可以后续展开，这里不赘述！此处重点说明其如何使">
<meta property="og:type" content="article">
<meta property="og:title" content="No title">
<meta property="og:url" content="https://github.com/cstsinghua/2016/07/01/Protocol Buffers使用说明/index.html">
<meta property="og:site_name" content="Atypical programmer">
<meta property="og:description" content="Protocol Buffers简介Protocol Buffers是一种数据交换格式，用于结构化数据的读写，类似于序列化机制。在线客服系统里面Message的body部分其实就是具有结构化的数据，因此可以采用Protocol Buffers来实现各平台和语言之间的消息传输。Protocol Buffers特点以及与XML、各语言的序列化机制等的比较，可以后续展开，这里不赘述！此处重点说明其如何使">
<meta property="og:updated_time" content="2016-07-01T02:05:11.427Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="No title">
<meta name="twitter:description" content="Protocol Buffers简介Protocol Buffers是一种数据交换格式，用于结构化数据的读写，类似于序列化机制。在线客服系统里面Message的body部分其实就是具有结构化的数据，因此可以采用Protocol Buffers来实现各平台和语言之间的消息传输。Protocol Buffers特点以及与XML、各语言的序列化机制等的比较，可以后续展开，这里不赘述！此处重点说明其如何使">
  
    <link rel="alternative" href="/atom.xml" title="Atypical programmer" type="application/atom+xml">
  
  <meta name="summary" content="写给典型的程序员">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="loading" class="active"></div>

  <nav id="menu" class="hide" >
   <div class="inner flex-row-vertical">
  <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
      <i class="icon icon-lg icon-close"></i>
  </a>
  <div class="brand-wrap">
    <div class="brand">
      <a href="/" class="avatar"><img src="/img/logo.jpg"></a>
      <hgroup class="introduce">
        <h5 class="nickname">Cstsinghua</h5>
        <a href="mailto:undefined" title="cstsinghua@126.com" class="mail">cstsinghua@126.com</a>
      </hgroup>
    </div>
  </div>
  <ul class="nav flex-col">
    
        <li class="waves-block waves-effect">
          <a href="/"  >
            <i class="icon icon-lg icon-home"></i>
            主页
          </a>
        </li>
    
        <li class="waves-block waves-effect">
          <a href="/archives"  >
            <i class="icon icon-lg icon-archives"></i>
            Archives
          </a>
        </li>
    
        <li class="waves-block waves-effect">
          <a href="/categories/Android"  >
            <i class="icon icon-lg icon-android"></i>
            Android
          </a>
        </li>
    
        <li class="waves-block waves-effect">
          <a href="/categories/Java"  >
            <i class="icon icon-lg icon-coffee"></i>
            Java
          </a>
        </li>
    
        <li class="waves-block waves-effect">
          <a href="/categories/Python"  >
            <i class="icon icon-lg icon-product-hunt"></i>
            Python
          </a>
        </li>
    
        <li class="waves-block waves-effect">
          <a href="/categories/杂项/"  >
            <i class="icon icon-lg icon-book"></i>
            杂项
          </a>
        </li>
    
        <li class="waves-block waves-effect">
          <a href="/tags"  >
            <i class="icon icon-lg icon-tags"></i>
            Tags
          </a>
        </li>
    
        <li class="waves-block waves-effect">
          <a href="https://github.com/cstsinghua" target="_blank" >
            <i class="icon icon-lg icon-github"></i>
            Github
          </a>
        </li>
    
        <li class="waves-block waves-effect">
          <a href="https://developer.android.com"  >
            <i class="icon icon-lg icon-link"></i>
            Android官网
          </a>
        </li>
    
  </ul>

  <footer class="footer">
  <p><a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0;vertical-align:middle;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAAllBMVEUAAAD///+rsapERER3d3eIiIjMzMzu7u4iIiKUmZO6v7rKzsoODg4RERFVVVUNDQ0NDg0PEA8zMzNLTEtbXltmZmZydnF9gn2AgICPkI+ZmZmqqqq7u7vFxsXIzMgNDQwZGRkgICAhISEkJSMnKCcuMC4xMzE5Ozk7PTtBQkFCQkJDQ0Nna2eGhoaHh4ezuLLGysbd3d1wVGpAAAAA4UlEQVR42q2T1xqCMAyFk7QsBQeKA9x7j/d/OSm22CpX0nzcpA1/T05aAOuBVkMAScQFHLnEwoCo2f1TnQIGoVMewjZEjVFN4GH1Ue1Cn2jWqwfsOOj6wDwGvotsl/c8lv7KIq1eLOsT0HMFHMIE/RZyHnlphryT9zyV+8WH5e8yQw3wnQvgAFxPTKUVi555SHR/lOfLMgVTeDlSfN+TaoUsiTyeIm+bCkHvCA2FUKG48LDtYBZBknsYP/G8NTw0gaaHyuQf4H5pecrB/FYCT2sL9zAfy1Xyjou6L8X2W7YcLyBZCRtnq/zfAAAAAElFTkSuQmCC" /></a></p>
  <p>Atypical programmer &copy; 2016</p>
  <p>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme
  <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></p>
  <a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-2x icon-rss-square"></i></a>
</footer>

</div>

  </nav>
  <main id="main">
    <header class="header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">No title</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input " autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-share">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header">
  <div class="container">
    <h1 class="author">No title</h1>
    <h5 class="subtitle">2016-07-01</h5>
  </div>
</header>

    <div class="container body-wrap">
      
  <article id="post-Protocol Buffers使用说明" class="article article-type-post" itemprop="blogPost">
    
      <div class="post-meat flex-row">
        <div class="flex-col"></div>
      </div>
      <div class="post-body">

        <aside class="post-widget" id="post-widget">

          
          <div class="post-share" id="post-share">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" href="javascript:;" data-title="微博" data-service="tsina">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns" href="javascript:;" data-title="微信" data-service="weixin">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" href="javascript:;" data-title=" QQ" data-service="cqq">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" href="javascript:;" data-title=" Facebook" data-service="fb">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" href="javascript:;" data-title=" Twitter" data-service="twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="douban share-sns" href="javascript:;" data-title="豆瓣" data-service="douban">
          豆
        </a>
      </li>
    </ul>
 </div>

          

          
          <nav class="post-toc-wrap" id="post-toc">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Protocol-Buffers简介"><span class="post-toc-text">Protocol Buffers简介</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Protocol-Buffers的使用"><span class="post-toc-text">Protocol Buffers的使用</span></a></li></ol>
          </nav>
          
        </aside>

        <div class="post-main">

            <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="Protocol-Buffers简介"><a href="#Protocol-Buffers简介" class="headerlink" title="Protocol Buffers简介"></a>Protocol Buffers简介</h1><p>Protocol Buffers是一种数据交换格式，用于结构化数据的读写，类似于序列化机制。在线客服系统里面Message的body部分其实就是具有结构化的数据，因此可以采用Protocol Buffers来实现各平台和语言之间的消息传输。Protocol Buffers特点以及与XML、各语言的序列化机制等的比较，可以后续展开，这里不赘述！此处重点说明其如何使用，特别是针对java(Android)平台。</p>
<p>Github地址：<a href="https://github.com/google/protobuf">https://github.com/google/protobuf</a></p>
<p>官方地址：<a href="https://developers.google.com/protocol-buffers/" target="_blank" rel="external"> https://developers.google.com/protocol-buffers/</a></p>
<h1 id="Protocol-Buffers的使用"><a href="#Protocol-Buffers的使用" class="headerlink" title="Protocol Buffers的使用"></a>Protocol Buffers的使用</h1><p>Protocol Buffers分为如下几个步骤</p>
<ol>
<li><p><strong>Defining Your Protocol Format(定义数据交换的协议格式)</strong></p>
<p> 简单来说，就是类似于定义面向对象语言中的类，其相当于一个数据结构，对应用程序中要交换的数据做一个定义，包括各种字段的声明等等。其文件扩展名为.proto。对于.proto文件如何定义和其语法规范，请详细阅读<a href="https://developers.google.com/protocol-buffers/docs/proto3" title="Protocol Buffer Language Guide" target="_blank" rel="external">Protocol Buffer Language Guide</a>。这里是proto3版本(最新版本，建议采用)，proto2的也可以参阅<a href="https://developers.google.com/protocol-buffers/docs/proto" target="_blank" rel="external">proto2 Language Guide</a></p>
<p> .proto示例(addressbook.proto)：</p>
</li>
</ol>
<pre><code>//
// Note: START and END tags are used in comments to define sections used in
// tutorials.  They are not part of the syntax for Protocol Buffers.
//
// To get an in-depth walkthrough of this file and the related examples, see:
// https://developers.google.com/protocol-buffers/docs/tutorials

// [START declaration]
syntax = &quot;proto3&quot;;
package tutorial;
// [END declaration]

// [START java_declaration]
option java_package = &quot;com.example.tutorial&quot;;
option java_outer_classname = &quot;AddressBookProtos&quot;;
// [END java_declaration]

// [START csharp_declaration]
option csharp_namespace = &quot;Google.Protobuf.Examples.AddressBook&quot;;
// [END csharp_declaration]

// [START messages]
message Person {
  string name = 1;
  int32 id = 2;  // Unique ID number for this person.
  string email = 3;

  enum PhoneType {
    MOBILE = 0;
    HOME = 1;
    WORK = 2;
  }

  message PhoneNumber {
    string number = 1;
    PhoneType type = 2;
  }

  repeated PhoneNumber phones = 4;
}

// Our address book file is just one of these.
message AddressBook {
  repeated Person people = 1;
}
// [END messages]
</code></pre><ol>
<li><p><strong>Protocol Compiler Installation(获取protoc可执行二进制文件)</strong></p>
<p> 可以在Github和其官方地址上看到相关的说明，但是个人觉得其让人不觉明历，通俗来说，这一步就是要生成一个可执行的protoc二进制文件(在windows平台下即protoc.exe)。这里以Windows平台为例说明(后续如无特殊说明，均默认是Windows平台)。建议直接使用Google提供的已经编译好的二进制可执行文件(<a href="http://repo1.maven.org/maven2/com/google/protobuf/protoc/" title="protoc可执行二进制文件下载" target="_blank" rel="external">http://repo1.maven.org/maven2/com/google/protobuf/protoc/</a>)，建议选择最新版本下载(根据自己操作系统的平台选择对应版本)。想要自己编译生成也可以，不过会遇到各种坑，感兴趣的童鞋可以尝试之<a href="https://github.com/google/protobuf/releases" title="下载protocol buffer源码包">protocol buffer源码包</a>。</p>
<p> protoc.exe是干什么的呢？其用来编译用户定义的数据结构即步骤1中编写的.proto文件，详细参见步骤3.</p>
</li>
<li><p><strong>Compiling Your Protocol Buffers(编译Protocol Buffers，即编译.proto文件)</strong></p>
<p>即用步骤2得到的protoc可执行二进制文件编译步骤1所得的.proto文件，最终生成语言相关的类(代码)。这里以java语言为例：其命令格式如下：</p>
<p>protoc -I=$SRC_DIR –java_out=$DST_DIR $SRC_DIR/addressbook.proto</p>
<p>eg:</p>
<pre><code>D:\protobuf-3.0.0-beta-2\src&gt;protoc.exe -I=D:\protobuf-3.0.0-beta-2\src --java_out=D:\kefu D:\protob
uf-3.0.0-beta-2\src\boyim.proto
</code></pre><p>如上，进入命令行，protoc即protoc可执行二进制文件，指定$SRC_DIR：源目录 (一般情况下即你的应用程序所在目录 – 如果不提供的话，则默认为当前工作目录即当前命令行的目录)；$DST_DIR：目标目录(你所期望生成的代码存放的目录; 通常情况下与源目录一致)；$SRC_DIR/addressbook.proto：即.proto文件的路径. </p>
<p>因为这里是生成java类, 因此使用 –java_out 选项 ， 类似的选项可以用于其它支持的语言.<br>对于addressbook.proto示例，这会在目标目录下生成 com/example/tutorial/AddressBookProtos.java文件.可以查看该文件，与普通的javaBean相似，包含了很多setters/getters方法，另外有一个builder方法，用于方便构造类对象。</p>
</li>
<li><p><strong>Protobuf Runtime Installation(生成Protocol Buffer API接口，用于支持操作步骤三生成的类，即核心的数据序列化和反序列化机制等包含在此API中)</strong></p>
</li>
</ol>
<pre><code>对于java语言而言，就是生成一个Protocol Buffer API的jar包，应用里面导入该jar包即可，其他语言类似。那么如何生成这个API库呢？


官方说明可以参见[Protobuf Runtime Installation](https://github.com/google/protobuf/tree/master/java)

这里简化说明(建议使用maven来完成安装)：


- 安装maven(注意需要安装JDK1.7及其以上版本)

    maven下载地址(目前最新版本3.3.9)，[http://maven.apache.org/](http://maven.apache.org/ &quot;maven下载地址&quot;)。下载之后解压，然后将解压后得到的目录路径添加到系统path中，这样使得可以直接在命令行使用mvn命令。

- 下载protocol buffer源码包

    [protocol buffer源码包](https://github.com/google/protobuf/releases &quot;下载protocol buffer源码包&quot;)。注意：这里下载的版本必须与步骤2中protoc可执行二进制文件的版本一致，要查看protoc可执行二进制文件的版本，可以在命令行输入protoc --version。下载之后，解压，找到对应语言目录(java)，如下图：

    ![](http://i.imgur.com/hqbfZFn.png)

    从命令行进入java目录。

    **注意1：**步骤2下载二进制可执行文件之后需要将二进制可执行文件改名为protoc.exe(Windows平台)，并且放置在如下目录(下载的protocol buffer源码包解压目录下的src子目录下)：

    ![](http://i.imgur.com/4Qdnw7s.png)

    **注意2：**需要将java目录下的pom.xml(即maven执行所依据的文件，类似于ant构建时候的build.xml)中添加编码格式，否则构建会采用操作系统默认的编码，Windows平台中文的话是GBK，而我们在Android平台采用的是UTF_8。添加部分代码如下：

        &lt;!-- pom.xml --&gt;
        &lt;properties&gt;
            &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
            &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;
        &lt;/properties&gt;

    ![](http://i.imgur.com/q5WtQgd.png)


- Run the tests(先测试运行，看看是否配置ok)

    在命令输入：

        mvn test

    确保成功再进行下一步。


- 生成jar包

    在命令输入：

        mvn package

    生成的jar包放置在java目录的子目录target下面。

    ![](http://i.imgur.com/dLL5Os3.png)
</code></pre><ol>
<li><p><strong>Parsing and Serialization(解析和序列化)</strong></p>
<p> 这一步也就是最终我们在应用程序里面对数据进行解析读写等直观的操作，也是我们最关心的部分。</p>
<p> 将步骤3生成的java类复制进工程中(注意必须在其定义的包名结构下)，同时将步骤4生成的jar导入到工程中。</p>
<p> 对于步骤3生成的类，利用 protocol buffer的二进制格式，每个类均具有所选择类型的写和读消息功能。即可以进行解析和序列化操作。这里列举几个：</p>
<pre><code>byte[] toByteArray();: serializes the message and returns a byte array containing its raw bytes.

static Type(定义的类，比如步骤1中的Person) parseFrom(byte[] data);: parses a message from the given byte array.

void writeTo(OutputStream output);: serializes the message and writes it to an OutputStream.

static Type(定义的类，比如步骤1中的Person) parseFrom(InputStream input);: reads and parses a message from an InputStream.
</code></pre><p> 事实上，每个类包含有大量的解析和序列化的方法。 请参照<a href="https://developers.google.com/protocol-buffers/docs/reference/java/com/google/protobuf/Message" target="_blank" rel="external"> Message API reference</a>进行详细查阅。</p>
</li>
</ol>

            <blockquote>
              <p>
                本文地址：
                <a href="https://github.com/cstsinghua/2016/07/01/Protocol Buffers使用说明/" target="_blank" rel="external">https://github.com/cstsinghua/2016/07/01/Protocol Buffers使用说明/</a>
              </p>
              <footer><cite><a href="https://github.com/cstsinghua">@Atypical programmer</a></cite></footer>
            </blockquote>
            </div>
            
<nav class="post-nav">
  

  
    <div class="waves-block waves-effect next fr">
      <a href="/2016/06/16/Github pages+Hexo+Nodejs搭建个人blog/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Github pages+Hexo+Nodejs搭建个人blog</h4>
      </a>
    </div>
  
</nav>



            
<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="Protocol Buffers使用说明" data-title="" data-url="https://github.com/cstsinghua/2016/07/01/Protocol Buffers使用说明/index.html"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"cstsinghua"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>






        </div>

      </div>

    

  </article>



    </div>
  </main>
<div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>

<script>
var BLOG_SHARE = {
    title: "No title",
    pic: "/img/logo.jpg",
    summary: document.getElementsByName('summary')[0].content,
    url: "https://github.com/cstsinghua/2016/07/01/Protocol Buffers使用说明/index.html"
};
</script>
<div class="global-share" id="global-share">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" href="javascript:;" data-title="微博" data-service="tsina">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns" href="javascript:;" data-title="微信" data-service="weixin">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" href="javascript:;" data-title=" QQ" data-service="cqq">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" href="javascript:;" data-title=" Facebook" data-service="fb">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" href="javascript:;" data-title=" Twitter" data-service="twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="douban share-sns" href="javascript:;" data-title="豆瓣" data-service="douban">
          豆
        </a>
      </li>
    </ul>
 </div>



<script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script src="/js/main.js"></script>



<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<script type="text/template" id="search-tpl">
<li class="item">
    <a href="/{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</script>

<script src="/js/search.js"></script>









</body>
</html>
