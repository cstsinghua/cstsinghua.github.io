<!DOCTYPE html>
<html>
<head>
    

    

    
<!-- Baidu Tongji -->
<script>var _hmt = _hmt || []</script>
<script async src="//hm.baidu.com/hm.js?338a0bb40db1ba116191683538324875"></script>
<!-- End Baidu Tongji -->




    <meta charset="utf-8">
    
    
    
    <link rel="canonical" href="https://cstsinghua.github.io/2018/07/19/Appium启动和日志分析/">
    
    
    <title>Appium启动和日志分析 | Atypical programmer | 做一个非典型程序员</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="NodeJS,Appium,启动,日志分析,源码分析,source analysis,load,bootstrap,log analysis,implementation,under the hood">
    <meta name="description" content="Appium简介Appium 是一个开源工具，用于自动化 iOS 手机 、 Android 手机和 Windows 桌面平台上的原生、移动 Web 和混合应用。“原生应用”指那些用 iOS 、 Android 或者 Windows SDK 编写的应用。“移动 web 应用”是用移动端浏览器访问的应用（Appium 支持 iOS 上的 Safari 、Chrome 和 Android 上的内置浏览">
<meta property="og:type" content="article">
<meta property="og:title" content="Appium启动和日志分析">
<meta property="og:url" content="https://cstsinghua.github.io/2018/07/19/Appium启动和日志分析/index.html">
<meta property="og:site_name" content="Atypical programmer">
<meta property="og:description" content="Appium简介Appium 是一个开源工具，用于自动化 iOS 手机 、 Android 手机和 Windows 桌面平台上的原生、移动 Web 和混合应用。“原生应用”指那些用 iOS 、 Android 或者 Windows SDK 编写的应用。“移动 web 应用”是用移动端浏览器访问的应用（Appium 支持 iOS 上的 Safari 、Chrome 和 Android 上的内置浏览">
<meta property="og:image" content="https://i.imgur.com/rTjLxcN.png">
<meta property="og:image" content="https://i.imgur.com/VJdKVvo.jpg">
<meta property="og:image" content="https://i.imgur.com/DMPCiSn.jpg">
<meta property="og:updated_time" content="2018-07-19T10:34:29.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Appium启动和日志分析">
<meta name="twitter:description" content="Appium简介Appium 是一个开源工具，用于自动化 iOS 手机 、 Android 手机和 Windows 桌面平台上的原生、移动 Web 和混合应用。“原生应用”指那些用 iOS 、 Android 或者 Windows SDK 编写的应用。“移动 web 应用”是用移动端浏览器访问的应用（Appium 支持 iOS 上的 Safari 、Chrome 和 Android 上的内置浏览">
<meta name="twitter:image" content="https://i.imgur.com/rTjLxcN.png">
    
        <link rel="alternate" type="application/atom+xml" title="Atypical programmer" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/logo.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Cstsinghua</h5>
          <a href="mailto:cstsinghua@126.com" title="cstsinghua@126.com" class="mail">cstsinghua@126.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/Android"  >
                <i class="icon icon-lg icon-android"></i>
                Android
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/Java"  >
                <i class="icon icon-lg icon-coffee"></i>
                Java
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/Python"  >
                <i class="icon icon-lg icon-product-hunt"></i>
                Python
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/NodeJS"  >
                <i class="icon icon-lg icon-shield"></i>
                NodeJS
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/版本控制/"  >
                <i class="icon icon-lg icon-git"></i>
                版本控制
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/杂项/"  >
                <i class="icon icon-lg icon-book"></i>
                杂项
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags/"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/sitemap.xml"  >
                <i class="icon icon-lg icon-sitemap"></i>
                Sitemap
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/cstsinghua" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://developer.android.com"  >
                <i class="icon icon-lg icon-link"></i>
                Android官网
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Appium启动和日志分析</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Appium启动和日志分析</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-07-19T10:34:24.000Z" itemprop="datePublished" class="page-time">
  2018-07-19
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/">Android</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/Test/">Test</a></li></ul></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Appium简介"><span class="post-toc-number">1.</span> <span class="post-toc-text">Appium简介</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Appium的原理和架构"><span class="post-toc-number">2.</span> <span class="post-toc-text">Appium的原理和架构</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Appium的源码结构"><span class="post-toc-number">3.</span> <span class="post-toc-text">Appium的源码结构</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Appium的日志分析"><span class="post-toc-number">4.</span> <span class="post-toc-text">Appium的日志分析</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#参考目录"><span class="post-toc-number">5.</span> <span class="post-toc-text">参考目录</span></a></li></ol>
        </nav>
    </aside>


<article id="post-Appium启动和日志分析"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Appium启动和日志分析</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-07-19 18:34:24" datetime="2018-07-19T10:34:24.000Z"  itemprop="datePublished">2018-07-19</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/">Android</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/Test/">Test</a></li></ul></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <a id="more"></a>
<h1 id="Appium简介"><a href="#Appium简介" class="headerlink" title="Appium简介"></a>Appium简介</h1><p>Appium 是一个开源工具，用于自动化 iOS 手机 、 Android 手机和 Windows 桌面平台上的原生、移动 Web 和混合应用。“原生应用”指那些用 iOS 、 Android 或者 Windows SDK 编写的应用。“移动 web 应用”是用移动端浏览器访问的应用（Appium 支持 iOS 上的 Safari 、Chrome 和 Android 上的内置浏览器）。“混合应用”带有一个 “webview” 的包装器——用来和 Web 内容交互的原生控件。类似 <a href="http://phonegap.com/" target="_blank" rel="external">Phonegap</a> 的项目，让用 Web 技术开发然后打包进原生包装器创建一个混合应用变得容易了。</p>
<p>重要的是，Appium 是跨平台的：它允许你用同样的 API 对多平台写测试，做到在 iOS 、Android 和 Windows 测试套件之间复用代码。</p>
<p>了解 Appium “支持”这些平台意味着什么、有哪些自动化方式的详细信息，请参见<a href="https://github.com/appium/appium/blob/master/docs/cn/appium-setup/platform-support.md" target="_blank" rel="external"> Appium 支持的平台</a>。</p>
<ol>
<li>Appium官网：<a href="http://appium.io/" target="_blank" rel="external">http://appium.io/</a></li>
<li>Appium的Github仓库：<a href="https://github.com/appium/appium" target="_blank" rel="external">https://github.com/appium/appium</a></li>
</ol>
<h1 id="Appium的原理和架构"><a href="#Appium的原理和架构" class="headerlink" title="Appium的原理和架构"></a>Appium的原理和架构</h1><p><strong>图1：</strong><br><img src="https://i.imgur.com/rTjLxcN.png" alt=""><br>以python语言为例，假设脚本(main.py)中只有“点击按钮btn1”这一个动作,对应的语句为：find_element_by_id(“btn1”).click()。那么appium的工作流程如下：</p>
<ol>
<li><p>启动appium server，它会自动完成如下一些事：</p>
<p> (1) appPackage=” ${aapt解析出来的被测应用包名}”，例如在地方棋牌大厅这个例子中，是package=”com.boyaa.engineqpsc”</p>
<p> (2) appActivity=” ${ aapt解析出来的被测应用启动Activity}” ，例如在地方棋牌大厅这个例子中，是targetPackage =”com.boyaa.engineqpsc.Game”<br> <strong>图2：</strong><br> <img src="https://i.imgur.com/VJdKVvo.jpg" alt=""></p>
</li>
<li><p>执行main.py, 把main.py交给appium python client解析执行。</p>
</li>
<li><p>python client把动作包装成http请求，发送给appium http server。</p>
</li>
<li><p>http server把“点击按钮1”请求解析成socket client和server之间规定的通信格式，并通过socket发送请求到手机。</p>
</li>
<li><p>运行在手机上的socket server，负责把“点击按钮1”请求解析为具体的手机本地api，并调用手机本地服务执行。</p>
</li>
<li><p>执行结果沿着上述通信路线层层返回。</p>
</li>
</ol>
<p>其他语言的工作流程也基本一致，区别只在于appium client这里，各个语言的API略有区别。</p>
<p>由此可以看出，appium server最大的好处是，在具体的命令执行上封装了一层统一的基于http协议构建的请求格式，不同语言的客户端可以无差别地调用。</p>
<p>When all is said and done, <strong>Appium is just an HTTP server</strong>. It sits and waits for connections from a client, which then instructs Appium what kind of session to start and what kind of automation behaviors to enact once a session is started.This means that you never use Appium just by itself. <strong>You always have to use it with a client library of some kind (or, if you’re adventurous, cURL!).</strong></p>
<p>Luckily, Appium speaks the same protocol as <a href="http://www.seleniumhq.org/" target="_blank" rel="external">Selenium</a>, called the WebDriver Protocol. You can do a lot of things with Appium just by using one of the standard Selenium clients. You may even have one of these on your system already. It’s enough to get started, especially if you’re using Appium for the purpose of testing web browsers on mobile platforms.</p>
<p>Appium can do things that Selenium can’t, though, just like mobile devices can do things that web browsers can’t. For that reason, we have a set of Appium clients in a variety of programming languages, that extend the regular old Selenium clients with additional functionality. You can see the list of clients and links to download instructions at the <a href="/docs/en/about-appium/appium-clients.md">Appium clientslist</a>.</p>
<p>Before moving forward, make sure you have a client downloaded in your favorite language and ready to go.</p>
<h1 id="Appium的源码结构"><a href="#Appium的源码结构" class="headerlink" title="Appium的源码结构"></a>Appium的源码结构</h1><p>从Appium的<a href="https://github.com/appium/appium" target="_blank" rel="external">Github仓库</a>将源码clone下来之后(本文采用的是2018.7.16日的最新master分支，将源码仓库用<code>git clone https://github.com/appium/appium.git</code>命令clone之后，在Appium本地仓库目录用<code>git checkout fe1b58b09b27ee397de33fb740ca4a348316676e</code>命令切换到本文采用的版本)，在文件系统中，看到的目录结构如下图：<br><img src="https://i.imgur.com/DMPCiSn.jpg" alt=""></p>
<p>Appium的源码工程是一个典型的NodeJS工程(Appium is written in JavaScript, and run with the Node.js engine. Currently version 6+ is supported. )，可以采用<a href="https://code.visualstudio.com/" target="_blank" rel="external">Visual studio code</a>打开(最新版的Appium工程就是在vs code下开发，从上图中的<code>.vscode</code>子目录即可看出)，其中，lib子目录是Appium的源码目录。而里面的<code>main.js</code>是Appium的程序入口。用vs code打开Appium源码所在根目录即将整个工程导入并打开，然后在<strong>根目录下打开命令行</strong>，在命令行执行<code>npm install</code>安装工程依赖的所有NodeJS library)。</p>
<h1 id="Appium的日志分析"><a href="#Appium的日志分析" class="headerlink" title="Appium的日志分析"></a>Appium的日志分析</h1><p>我们从<code>main.js</code>入手，一步步分析Appium的内部逻辑和日志打印。<code>main.js</code>的main入口函数代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">99</span>     <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span> (<span class="params">args = null</span>) </span>&#123;</span><br><span class="line"><span class="number">100</span>      <span class="keyword">let</span> parser = getParser();</span><br><span class="line"><span class="number">101</span>      <span class="keyword">let</span> throwInsteadOfExit = <span class="literal">false</span>;</span><br><span class="line"><span class="number">102</span>      <span class="keyword">if</span> (args) &#123;</span><br><span class="line"><span class="number">103</span>        <span class="comment">// a containing package passed in their own args, let's fill them out</span></span><br><span class="line"><span class="number">104</span>        <span class="comment">// with defaults</span></span><br><span class="line"><span class="number">105</span>        args = <span class="built_in">Object</span>.assign(&#123;&#125;, getDefaultArgs(), args);</span><br><span class="line"><span class="number">106</span></span><br><span class="line"><span class="number">107</span>        <span class="comment">// if we have a containing package instead of running as a CLI process,</span></span><br><span class="line"><span class="number">108</span>        <span class="comment">// that package might not appreciate us calling 'process.exit' willy-</span></span><br><span class="line"><span class="number">109</span>        <span class="comment">// nilly, so give it the option to have us throw instead of exit</span></span><br><span class="line"><span class="number">110</span>        <span class="keyword">if</span> (args.throwInsteadOfExit) &#123;</span><br><span class="line"><span class="number">111</span>          throwInsteadOfExit = <span class="literal">true</span>;</span><br><span class="line"><span class="number">112</span>          <span class="comment">// but remove it since it's not a real server arg per se</span></span><br><span class="line"><span class="number">113</span>          <span class="keyword">delete</span> args.throwInsteadOfExit;</span><br><span class="line"><span class="number">114</span>        &#125;</span><br><span class="line"><span class="number">115</span>      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">116</span>        <span class="comment">// otherwise parse from CLI</span></span><br><span class="line"><span class="number">117</span>        args = parser.parseArgs();</span><br><span class="line"><span class="number">118</span>      &#125;</span><br><span class="line"><span class="number">119</span>      initHeapdump(args);</span><br><span class="line"><span class="number">120</span>      <span class="keyword">await</span> logsinkInit(args);</span><br><span class="line"><span class="number">121</span>      <span class="keyword">await</span> preflightChecks(parser, args, throwInsteadOfExit);</span><br><span class="line"><span class="number">122</span>      <span class="keyword">await</span> logStartupInfo(parser, args);</span><br><span class="line"><span class="number">123</span>      <span class="keyword">let</span> appiumDriver = <span class="keyword">new</span> AppiumDriver(args);</span><br><span class="line"><span class="number">124</span>      <span class="keyword">let</span> router = routeConfiguringFunction(appiumDriver);</span><br><span class="line"><span class="number">125</span>      <span class="keyword">let</span> server = <span class="keyword">await</span> baseServer(router, args.port, args.address);</span><br><span class="line"><span class="number">126</span>      appiumDriver.server = server;</span><br><span class="line"><span class="number">127</span>      <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">128</span>        <span class="comment">// TODO prelaunch if args.launch is set</span></span><br><span class="line"><span class="number">129</span>        <span class="comment">// <span class="doctag">TODO:</span> startAlertSocket(server, appiumServer);</span></span><br><span class="line"><span class="number">130</span></span><br><span class="line"><span class="number">131</span>        <span class="comment">// configure as node on grid, if necessary</span></span><br><span class="line"><span class="number">132</span>        <span class="keyword">if</span> (args.nodeconfig !== <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">133</span>          <span class="keyword">await</span> registerNode(args.nodeconfig, args.address, args.port);</span><br><span class="line"><span class="number">134</span>        &#125;</span><br><span class="line"><span class="number">135</span>      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line"><span class="number">136</span>        <span class="keyword">await</span> server.close();</span><br><span class="line"><span class="number">137</span>        <span class="keyword">throw</span> err;</span><br><span class="line"><span class="number">138</span>      &#125;</span><br><span class="line"><span class="number">139</span></span><br><span class="line"><span class="number">140</span>      process.once(<span class="string">'SIGINT'</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="number">141</span>        logger.info(<span class="string">`Received SIGINT - shutting down`</span>);</span><br><span class="line"><span class="number">142</span>        <span class="keyword">await</span> server.close();</span><br><span class="line"><span class="number">143</span>      &#125;);</span><br><span class="line"><span class="number">144</span></span><br><span class="line"><span class="number">145</span>      process.once(<span class="string">'SIGTERM'</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="number">146</span>        logger.info(<span class="string">`Received SIGTERM - shutting down`</span>);</span><br><span class="line"><span class="number">147</span>        <span class="keyword">await</span> server.close();</span><br><span class="line"><span class="number">148</span>      &#125;);</span><br><span class="line"><span class="number">149</span></span><br><span class="line"><span class="number">150</span>      logServerPort(args.address, args.port);</span><br><span class="line"><span class="number">151</span></span><br><span class="line"><span class="number">152</span>      <span class="keyword">return</span> server;</span><br><span class="line"><span class="number">153</span>    &#125;</span><br><span class="line"><span class="number">154</span></span><br><span class="line"><span class="number">155</span>    <span class="keyword">if</span> (<span class="built_in">require</span>.main === <span class="built_in">module</span>) &#123;</span><br><span class="line"><span class="number">156</span>      asyncify(main);</span><br><span class="line"><span class="number">157</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>100-118行，解析传入的参数args，这里一般是从命令行传入(比如加上-p用于指定Appium server的监听端口)，args可以指定的格式和内容请参见<a href="https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/server-args.md" target="_blank" rel="external">server-args</a>；</li>
<li>119行，initHeapdump函数，会根据启动参数中是否指明启动堆转储(应该是指将javascript的堆内存dump到磁盘文件，便于分析异常和内存泄露等问题)，这里不做深入探讨；</li>
<li>120行，logsinkInit函数，对log日志进行处理，比如添加颜色显示，或者添加前缀等；</li>
<li>121行，preflightChecks函数对NodeJS的版本和环境等进行一些检查；</li>
<li><p>122行，logStartupInfo函数打印Appium启动的信息，包括Appium的版本等(如图2所示)</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">61</span>    <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">logStartupInfo</span> (<span class="params">parser, args</span>) </span>&#123;</span><br><span class="line"><span class="number">62</span>      <span class="keyword">let</span> welcome = <span class="string">`Welcome to Appium v<span class="subst">$&#123;APPIUM_VER&#125;</span>`</span>;</span><br><span class="line"><span class="number">63</span>      <span class="keyword">let</span> appiumRev = <span class="keyword">await</span> getGitRev();</span><br><span class="line"><span class="number">64</span>      <span class="keyword">if</span> (appiumRev) &#123;</span><br><span class="line"><span class="number">65</span>        welcome += <span class="string">` (REV <span class="subst">$&#123;appiumRev&#125;</span>)`</span>;</span><br><span class="line"><span class="number">66</span>      &#125;</span><br><span class="line"><span class="number">67</span>      logger.info(welcome);</span><br><span class="line"><span class="number">68</span></span><br><span class="line"><span class="number">69</span>      <span class="keyword">let</span> showArgs = getNonDefaultArgs(parser, args);</span><br><span class="line"><span class="number">70</span>      <span class="keyword">if</span> (_.size(showArgs)) &#123;</span><br><span class="line"><span class="number">71</span>        logNonDefaultArgsWarning(showArgs);</span><br><span class="line"><span class="number">72</span>      &#125;</span><br><span class="line"><span class="number">73</span>      <span class="keyword">let</span> deprecatedArgs = getDeprecatedArgs(parser, args);</span><br><span class="line"><span class="number">74</span>      <span class="keyword">if</span> (_.size(deprecatedArgs)) &#123;</span><br><span class="line"><span class="number">75</span>        logDeprecationWarning(deprecatedArgs);</span><br><span class="line"><span class="number">76</span>      &#125;</span><br><span class="line"><span class="number">77</span>      <span class="keyword">if</span> (!_.isEmpty(args.defaultCapabilities)) &#123;</span><br><span class="line"><span class="number">78</span>        logDefaultCapabilitiesWarning(args.defaultCapabilities);</span><br><span class="line"><span class="number">79</span>      &#125;</span><br><span class="line"><span class="number">80</span>      <span class="comment">// <span class="doctag">TODO:</span> bring back loglevel reporting below once logger is flushed out</span></span><br><span class="line"><span class="number">81</span>      <span class="comment">//logger.info('Console LogLevel: ' + logger.transports.console.level);</span></span><br><span class="line"><span class="number">82</span>      <span class="comment">//if (logger.transports.file) &#123;</span></span><br><span class="line"><span class="number">83</span>        <span class="comment">//logger.info('File LogLevel: ' + logger.transports.file.level);</span></span><br><span class="line"><span class="number">84</span>      <span class="comment">//&#125;</span></span><br><span class="line"><span class="number">85</span>    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>123-126行，这是main函数的关键，这里真正创建了HTTP server，并接受Appium client发送的HTTP请求。123行创建的AppiumDriver定义在Appium源码的appium.js文件中，在其内部包含了createSession、 executeCommand等很多关键方法。createSession在Appium server接受到Appium client发送的”host:port/wd/hub/session”请求时被调用(相关映射可在<code>$APPIUM_ROOT_DIR/node_modules/appium-base-driver/lib/mjsonwp/routes.js</code>中定义，如下代码片段所示)，<code>$APPIUM_ROOT_DIR</code>表示Appium源码根目录，下文同义：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span>     <span class="comment">// define the routes, mapping of HTTP methods to particular driver commands,</span></span><br><span class="line"><span class="number">5</span>     <span class="comment">// and any parameters that are expected in a request</span></span><br><span class="line"><span class="number">6</span>     <span class="comment">// parameters can be `required` or `optional`</span></span><br><span class="line"><span class="number">7</span>     <span class="keyword">const</span> METHOD_MAP = &#123;</span><br><span class="line"><span class="number">8</span>       <span class="string">'/wd/hub/status'</span>: &#123;</span><br><span class="line"><span class="number">9</span>         GET: &#123;command: <span class="string">'getStatus'</span>&#125;</span><br><span class="line"><span class="number">10</span>      &#125;,</span><br><span class="line"><span class="number">11</span>      <span class="string">'/wd/hub/session'</span>: &#123;</span><br><span class="line"><span class="number">12</span>        POST: &#123;command: <span class="string">'createSession'</span>, payloadParams: &#123;</span><br><span class="line"><span class="number">13</span>          validate: (jsonObj) =&gt; (!jsonObj.capabilities &amp;&amp; !jsonObj.desiredCapabilities) &amp;&amp; <span class="string">'we require one of "desiredCapabilities" or "capabilities" object'</span>,</span><br><span class="line"><span class="number">14</span>          optional: [<span class="string">'desiredCapabilities'</span>, <span class="string">'requiredCapabilities'</span>, <span class="string">'capabilities'</span>]&#125;&#125;</span><br><span class="line"><span class="number">15</span>      &#125;,</span><br><span class="line"><span class="number">16</span>      .</span><br><span class="line"><span class="number">17</span>      .</span><br><span class="line"><span class="number">18</span>      .</span><br><span class="line"><span class="number">474</span>     &#125;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>124行的routeConfiguringFunction函数(从函数的名称可知，表示路由配置)，定义在<code>$APPIUM_ROOT_DIR/node_modules/appium-base-driver/lib/mjsonwp/mjsonwp.js</code>，如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">193</span>    <span class="function"><span class="keyword">function</span> <span class="title">routeConfiguringFunction</span> (<span class="params">driver</span>) </span>&#123;</span><br><span class="line"><span class="number">194</span>      <span class="keyword">if</span> (!driver.sessionExists) &#123;</span><br><span class="line"><span class="number">195</span>        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Drivers used with MJSONWP must implement `sessionExists`'</span>);</span><br><span class="line"><span class="number">196</span>      &#125;</span><br><span class="line"><span class="number">197</span></span><br><span class="line"><span class="number">198</span>      <span class="keyword">if</span> (!(driver.executeCommand || driver.execute)) &#123;</span><br><span class="line"><span class="number">199</span>        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Drivers used with MJSONWP must implement `executeCommand` or `execute`'</span>);</span><br><span class="line"><span class="number">200</span>      &#125;</span><br><span class="line"><span class="number">201</span></span><br><span class="line"><span class="number">202</span>      <span class="comment">// return a function which will add all the routes to the driver</span></span><br><span class="line"><span class="number">203</span>      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">app</span>) </span>&#123;</span><br><span class="line"><span class="number">204</span>        <span class="keyword">for</span> (<span class="keyword">let</span> [path, methods] <span class="keyword">of</span> _.toPairs(METHOD_MAP)) &#123;</span><br><span class="line"><span class="number">205</span>          <span class="keyword">for</span> (<span class="keyword">let</span> [method, spec] <span class="keyword">of</span> _.toPairs(methods)) &#123;</span><br><span class="line"><span class="number">206</span>            <span class="comment">// set up the express route handler</span></span><br><span class="line"><span class="number">207</span>            buildHandler(app, method, path, spec, driver, isSessionCommand(spec.command));</span><br><span class="line"><span class="number">208</span>          &#125;</span><br><span class="line"><span class="number">209</span>        &#125;</span><br><span class="line"><span class="number">210</span>      &#125;;</span><br><span class="line"><span class="number">211</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>从中可得知，routeConfiguringFunction函数的功能和其名字完全对应。即根据<code>$APPIUM_ROOT_DIR/node_modules/appium-base-driver/lib/mjsonwp/routes.js</code>定义的METHOD_MAP映射，将Appium client发送的HTTP请求(请求的url的path代表了一条路由route)映射到该函数传入的driver参数的相应命令(函数)去执行。这里传入的driver就是123行定义的AppiumDriver，从而也印证了上文提到的，Appium client发送的”host:port/wd/hub/session”请求时，最终是调用了AppiumDriver的createSession方法(在appium.js的237-330行，可重点关注259和260两行的详细逻辑)。<br>回到main.js的125行<code>let server = await baseServer(router, args.port, args.address)</code>，该行是真正创建Appium运行的HTTP server。跟踪代码可知，baseServer真正定义在<code>$APPIUM_ROOT_DIR/node_modules/appium-base-driver/lib/express/server.js</code>中，如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>    <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">server</span> (<span class="params">configureRoutes, port, hostname = null</span>) </span>&#123;</span><br><span class="line"><span class="number">16</span>      <span class="comment">// create the actual http server</span></span><br><span class="line"><span class="number">17</span>      <span class="keyword">let</span> app = express();</span><br><span class="line"><span class="number">18</span>      <span class="keyword">let</span> httpServer = http.createServer(app);</span><br><span class="line"><span class="number">19</span></span><br><span class="line"><span class="number">20</span>      <span class="comment">// http.Server.close() only stops new connections, but we need to wait until</span></span><br><span class="line"><span class="number">21</span>      <span class="comment">// all connections are closed and the `close` event is emitted</span></span><br><span class="line"><span class="number">22</span>      <span class="keyword">let</span> close = httpServer.close.bind(httpServer);</span><br><span class="line"><span class="number">23</span>      httpServer.close = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line"><span class="number">24</span>        <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>((resolve, reject) =&gt; &#123;</span><br><span class="line"><span class="number">25</span>          httpServer.on(<span class="string">'close'</span>, resolve);</span><br><span class="line"><span class="number">26</span>          close((err) =&gt; &#123;</span><br><span class="line"><span class="number">27</span>            <span class="keyword">if</span> (err) reject(err);</span><br><span class="line"><span class="number">28</span>          &#125;);</span><br><span class="line"><span class="number">29</span>        &#125;);</span><br><span class="line"><span class="number">30</span>      &#125;;</span><br><span class="line"><span class="number">31</span></span><br><span class="line"><span class="number">32</span>      <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>((resolve, reject) =&gt; &#123;</span><br><span class="line"><span class="number">33</span>        httpServer.on(<span class="string">'error'</span>, (err) =&gt; &#123;</span><br><span class="line"><span class="number">34</span>          <span class="keyword">if</span> (err.code === <span class="string">'EADDRNOTAVAIL'</span>) &#123;</span><br><span class="line"><span class="number">35</span>            log.error(<span class="string">'Could not start REST http interface listener. '</span> +</span><br><span class="line"><span class="number">36</span>                      <span class="string">'Requested address is not available.'</span>);</span><br><span class="line"><span class="number">37</span>          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">38</span>            log.error(<span class="string">'Could not start REST http interface listener. The requested '</span> +</span><br><span class="line"><span class="number">39</span>                      <span class="string">'port may already be in use. Please make sure there is no '</span> +</span><br><span class="line"><span class="number">40</span>                      <span class="string">'other instance of this server running already.'</span>);</span><br><span class="line"><span class="number">41</span>          &#125;</span><br><span class="line"><span class="number">42</span>          reject(err);</span><br><span class="line"><span class="number">43</span>        &#125;);</span><br><span class="line"><span class="number">44</span>        httpServer.on(<span class="string">'connection'</span>, (socket) =&gt; &#123;</span><br><span class="line"><span class="number">45</span>          socket.setTimeout(<span class="number">600</span> * <span class="number">1000</span>); <span class="comment">// 10 minute timeout</span></span><br><span class="line"><span class="number">46</span>        &#125;);</span><br><span class="line"><span class="number">47</span>        configureServer(app, configureRoutes);</span><br><span class="line"><span class="number">48</span></span><br><span class="line"><span class="number">49</span>        <span class="keyword">let</span> serverArgs = [port];</span><br><span class="line"><span class="number">50</span>        <span class="keyword">if</span> (hostname) &#123;</span><br><span class="line"><span class="number">51</span>          <span class="comment">// If the hostname is omitted, the server will accept</span></span><br><span class="line"><span class="number">52</span>          <span class="comment">// connections on any IP address</span></span><br><span class="line"><span class="number">53</span>          serverArgs.push(hostname);</span><br><span class="line"><span class="number">54</span>        &#125;</span><br><span class="line"><span class="number">55</span>        httpServer.listen(...serverArgs, (err) =&gt; &#123;</span><br><span class="line"><span class="number">56</span>          <span class="keyword">if</span> (err) &#123;</span><br><span class="line"><span class="number">57</span>            reject(err);</span><br><span class="line"><span class="number">58</span>          &#125;</span><br><span class="line"><span class="number">59</span>          resolve(httpServer);</span><br><span class="line"><span class="number">60</span>        &#125;);</span><br><span class="line"><span class="number">61</span>      &#125;);</span><br><span class="line"><span class="number">62</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>可重点关注上面的47行即<code>configureServer(app, configureRoutes);</code>以及configureServer函数(比如该函数的88行<code>app.use(startLogFormatter);</code>，这行将会在收到Appium client的HTTP请求的时候，打印HTTP的方向”–&gt;”以及HTTP的请求方法比如POST等。startLogFormatter以及对应的endLogFormatter定义在<code>$APPIUM_ROOT_DIR/node_modules/appium-base-driver/lib/express/express-logging.js</code>中)的详细逻辑。最终客户端发送过来的HTTP请求(path，路径)，经过configureRoutes的路由(这里configureRoutes参数就是main.js里124行routeConfiguringFunction函数返回的router），找到AppiumDriver的对应方法处理。</p>
<ul>
<li>150行，logServerPort函数打印Appium server监听的IP地址和端口(如图2所示)。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">87</span>    <span class="function"><span class="keyword">function</span> <span class="title">logServerPort</span> (<span class="params">address, port</span>) </span>&#123;</span><br><span class="line"><span class="number">88</span>      <span class="keyword">let</span> logMessage = <span class="string">`Appium REST http interface listener started on `</span> +</span><br><span class="line"><span class="number">89</span>                       <span class="string">`<span class="subst">$&#123;address&#125;</span>:<span class="subst">$&#123;port&#125;</span>`</span>;</span><br><span class="line"><span class="number">90</span>      logger.info(logMessage);</span><br><span class="line"><span class="number">91</span>    &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>关于打印日志用到的logger，其实是定义在logger.js之中(Appium源码lib子目录下)，如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>    <span class="keyword">import</span> &#123; logger &#125; <span class="keyword">from</span> <span class="string">'appium-support'</span>;</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span>    <span class="keyword">let</span> log = logger.getLogger(<span class="string">'Appium'</span>);</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span>    <span class="keyword">export</span> <span class="keyword">default</span> log;</span><br></pre></td></tr></table></figure></p>
<p>进一步追踪，那么是来自Appium工程依赖的一个NodeJS library，即appium-support(查看Appium源码根目录下的package.json文件，可以在依赖配置里面找到对应的项，如下44行所示)。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">36    &quot;dependencies&quot;: &#123;</span><br><span class="line">37        &quot;appium-android-driver&quot;: &quot;3.x&quot;,</span><br><span class="line">38        &quot;appium-base-driver&quot;: &quot;^3.0.0&quot;,</span><br><span class="line">39        &quot;appium-espresso-driver&quot;: &quot;^1.0.0-beta.3&quot;,</span><br><span class="line">40        &quot;appium-fake-driver&quot;: &quot;^0.x&quot;,</span><br><span class="line">41        &quot;appium-ios-driver&quot;: &quot;2.x&quot;,</span><br><span class="line">42        &quot;appium-mac-driver&quot;: &quot;1.x&quot;,</span><br><span class="line">43        &quot;appium-selendroid-driver&quot;: &quot;1.x&quot;,</span><br><span class="line">44        &quot;appium-support&quot;: &quot;2.x&quot;,</span><br><span class="line">45        &quot;appium-tizen-driver&quot;: &quot;^1.0.0-beta&quot;,</span><br><span class="line">46        &quot;appium-uiautomator2-driver&quot;: &quot;1.x&quot;,</span><br><span class="line">47        &quot;appium-windows-driver&quot;: &quot;1.x&quot;,</span><br><span class="line">48        &quot;appium-xcuitest-driver&quot;: &quot;2.x&quot;,</span><br><span class="line">49        &quot;appium-youiengine-driver&quot;: &quot;1.x&quot;,</span><br><span class="line">50        &quot;argparse&quot;: &quot;^1.0.10&quot;,</span><br><span class="line">51        &quot;async-lock&quot;: &quot;^1.0.0&quot;,</span><br><span class="line">52        &quot;asyncbox&quot;: &quot;2.x&quot;,</span><br><span class="line">53        &quot;babel-runtime&quot;: &quot;=5.8.24&quot;,</span><br><span class="line">54        &quot;bluebird&quot;: &quot;3.x&quot;,</span><br><span class="line">55        &quot;continuation-local-storage&quot;: &quot;3.x&quot;,</span><br><span class="line">56        &quot;dateformat&quot;: &quot;^3.0.3&quot;,</span><br><span class="line">57        &quot;find-root&quot;: &quot;^1.1.0&quot;,</span><br><span class="line">58        &quot;lodash&quot;: &quot;=4.17.9&quot;,</span><br><span class="line">59        &quot;npmlog&quot;: &quot;4.x&quot;,</span><br><span class="line">60        &quot;request&quot;: &quot;^2.81.0&quot;,</span><br><span class="line">61        &quot;request-promise&quot;: &quot;4.x&quot;,</span><br><span class="line">62        &quot;semver&quot;: &quot;^5.5.0&quot;,</span><br><span class="line">63        &quot;source-map-support&quot;: &quot;0.x&quot;,</span><br><span class="line">64        &quot;teen_process&quot;: &quot;1.x&quot;,</span><br><span class="line">65        &quot;winston&quot;: &quot;2.x&quot;</span><br><span class="line">66      &#125;,</span><br></pre></td></tr></table></figure></p>
<p>而appium-support库，可以通过在Appium的源码根目录下执行<code>npm install</code>命令(要使用npm命令，前提是先<a href="https://nodejs.org/en/" target="_blank" rel="external">安装NodeJS</a>)来安装(<code>npm install</code>执行之后，会在Appium的源码根目录下生成node_modules子目录，node_modules目录中包含了Appium源码工程依赖的NodeJS library)，或者直接在其Github上的源码仓库<a href="https://github.com/appium/appium-support" target="_blank" rel="external">https://github.com/appium/appium-support</a>下载后查看。其打印相关的功能实际在<code>$APPIUM_ROOT_DIR/node_modules/appium-support/lib/logging.js</code>中定义($APPIUM_ROOT_DIR代表Appium的源码根目录)。该文件中<code>getLogger (prefix = null)</code>方法如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">42</span>    <span class="function"><span class="keyword">function</span> <span class="title">getLogger</span> (<span class="params">prefix = null</span>) </span>&#123;</span><br><span class="line"><span class="number">43</span>      <span class="keyword">let</span> [logger, usingGlobalLog] = _getLogger();</span><br><span class="line"><span class="number">44</span></span><br><span class="line"><span class="number">45</span>      <span class="comment">// wrap the logger so that we can catch and modify any logging</span></span><br><span class="line"><span class="number">46</span>      <span class="keyword">let</span> wrappedLogger = &#123;unwrap: () =&gt; logger&#125;;</span><br><span class="line"><span class="number">47</span></span><br><span class="line"><span class="number">48</span>      <span class="comment">// allow access to the level of the underlying logger</span></span><br><span class="line"><span class="number">49</span>      <span class="built_in">Object</span>.defineProperty(wrappedLogger, <span class="string">'level'</span>, &#123;</span><br><span class="line"><span class="number">50</span>        get: () =&gt; &#123; <span class="keyword">return</span> logger.level; &#125;,</span><br><span class="line"><span class="number">51</span>        set: (newValue) =&gt; &#123; logger.level = newValue; &#125;,</span><br><span class="line"><span class="number">52</span>        enumerable: <span class="literal">true</span>,</span><br><span class="line"><span class="number">53</span>        configurable: <span class="literal">true</span></span><br><span class="line"><span class="number">54</span>      &#125;);</span><br><span class="line"><span class="number">55</span>      <span class="comment">// add all the levels from `npmlog`, and map to the underlying logger</span></span><br><span class="line"><span class="number">56</span>      <span class="keyword">for</span> (<span class="keyword">let</span> level <span class="keyword">of</span> NPM_LEVELS) &#123;</span><br><span class="line"><span class="number">57</span>        wrappedLogger[level] = logger[level].bind(logger, prefix);</span><br><span class="line"><span class="number">58</span>      &#125;</span><br><span class="line"><span class="number">59</span>      <span class="comment">// add method to log an error, and throw it, for convenience</span></span><br><span class="line"><span class="number">60</span>      wrappedLogger.errorAndThrow = <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line"><span class="number">61</span>        <span class="comment">// make sure we have an `Error` object. Wrap if necessary</span></span><br><span class="line"><span class="number">62</span>        <span class="keyword">if</span> (!(err <span class="keyword">instanceof</span> <span class="built_in">Error</span>)) &#123;</span><br><span class="line"><span class="number">63</span>          err = <span class="keyword">new</span> <span class="built_in">Error</span>(err);</span><br><span class="line"><span class="number">64</span>        &#125;</span><br><span class="line"><span class="number">65</span>        <span class="comment">// log and throw</span></span><br><span class="line"><span class="number">66</span>        <span class="keyword">this</span>.error(err);</span><br><span class="line"><span class="number">67</span>        <span class="keyword">throw</span> err;</span><br><span class="line"><span class="number">68</span>      &#125;;</span><br><span class="line"><span class="number">69</span>      <span class="keyword">if</span> (!usingGlobalLog) &#123;</span><br><span class="line"><span class="number">70</span>        <span class="comment">// if we're not using a global log specified from some top-level package,</span></span><br><span class="line"><span class="number">71</span>        <span class="comment">// set the log level to a default of verbose. Otherwise, let the top-level</span></span><br><span class="line"><span class="number">72</span>        <span class="comment">// package set the log level</span></span><br><span class="line"><span class="number">73</span>        wrappedLogger.level = <span class="string">'verbose'</span>;</span><br><span class="line"><span class="number">74</span>      &#125;</span><br><span class="line"><span class="number">75</span>      wrappedLogger.levels = NPM_LEVELS;</span><br><span class="line"><span class="number">76</span>      <span class="keyword">return</span> wrappedLogger;</span><br><span class="line"><span class="number">77</span>    &#125;</span><br></pre></td></tr></table></figure></p>
<p>从而得知，getLogger方法传入的其实就是一个前缀，Appium在打印每行日志时，会在消息体前面加上这个前缀。</p>
<p>而在Appium源码lib子目录下的logger.js中，第4行<code>logger.getLogger(&#39;Appium&#39;)</code>其实是给Appium打印的每行日志加上<code>[Appium]</code>的前缀，这也就是我们在Appium日志中看到的(如本文图2所示)。那其他的前缀比如[HTTP]、[ADB]等又是在哪里添加的呢？类似的分析方法，可以在Appium源码工程依赖的对应的NodeJS library中查看，基本每个library都自定义了一个logger.js，与<code>$APPIUM_ROOT_DIR/lib/logger.js</code>类似，都是最终引用到appium-support库的logging.js(如上文所示)来实现，但是赋予了不同的前缀。比如，[HTTP]前缀表示Appium server接收或者返回HTTP请求给Appium client。前文提到，Appium server本身就是一个HTTP server，其底层采用<a href="https://expressjs.com/" target="_blank" rel="external">express框架</a>来简化搭建HTTP server(express is a fast, unopinionated, minimalist web framework for Node.js。<a href="https://github.com/openstf" target="_blank" rel="external">STF</a>平台的HTTP server其实也是采用express框架来搭建的)。<code>$APPIUM_ROOT_DIR/node_modules/appium-base-driver/lib/express/logger.js</code>定义如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>    <span class="keyword">import</span> &#123; logger &#125; <span class="keyword">from</span> <span class="string">'appium-support'</span>;</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span>    <span class="keyword">const</span> log = logger.getLogger(<span class="string">'HTTP'</span>);</span><br><span class="line"><span class="number">4</span>    <span class="keyword">export</span> <span class="keyword">default</span> log;</span><br></pre></td></tr></table></figure></p>
<p>可以看到就是这里添加了<code>[HTTP]</code>前缀。其他前缀包括日志级别同理可分析得之。</p>
<h1 id="参考目录"><a href="#参考目录" class="headerlink" title="参考目录"></a>参考目录</h1><ol>
<li><a href="http://mtc.baidu.com/about#appium" target="_blank" rel="external">http://mtc.baidu.com/about#appium</a></li>
<li><a href="https://github.com/appium/appium/blob/master/docs/cn/about-appium/intro.md" target="_blank" rel="external">https://github.com/appium/appium/blob/master/docs/cn/about-appium/intro.md</a></li>
<li><a href="https://blog.csdn.net/itfootball/article/details/45395901" target="_blank" rel="external">https://blog.csdn.net/itfootball/article/details/45395901</a></li>
<li><a href="https://blog.csdn.net/jffhy2017/article/details/69372064" target="_blank" rel="external">https://blog.csdn.net/jffhy2017/article/details/69372064</a></li>
</ol>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2018-07-19T10:34:29.000Z" itemprop="dateUpdated">2018-07-19 18:34:29</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="https://cstsinghua.github.io">
            <img src="/img/logo.jpg" alt="Cstsinghua">
            Cstsinghua
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Appium/">Appium</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NodeJS/">NodeJS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bootstrap/">bootstrap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/implementation/">implementation</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/load/">load</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/log-analysis/">log analysis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/source-analysis/">source analysis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/under-the-hood/">under the hood</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/启动/">启动</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/日志分析/">日志分析</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/源码分析/">源码分析</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://cstsinghua.github.io/2018/07/19/Appium启动和日志分析/&title=《Appium启动和日志分析》 — Atypical programmer&pic=https://cstsinghua.github.io/img/logo.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://cstsinghua.github.io/2018/07/19/Appium启动和日志分析/&title=《Appium启动和日志分析》 — Atypical programmer&source=写给典型的程序员" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://cstsinghua.github.io/2018/07/19/Appium启动和日志分析/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Appium启动和日志分析》 — Atypical programmer&url=https://cstsinghua.github.io/2018/07/19/Appium启动和日志分析/&via=https://cstsinghua.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://cstsinghua.github.io/2018/07/19/Appium启动和日志分析/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="waves-block waves-effect next">
      <a href="/2018/07/12/openGL学习路径/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">OpenGL学习路径</h4>
      </a>
    </div>
  
</nav>



    





<section class="comments" id="comments">
    <!-- UY BEGIN -->
    <div id="uyan_frame"></div>
    <script src="http://v2.uyan.cc/code/uyan.js?uid=2146219"></script>
    <!-- UY END -->
</section>







    <!-- Valine Comments -->
    <div class="comments vcomment" id="comments"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
    <!-- Valine Comments script -->
    <script>
        var GUEST_INFO = ['nick','mail','link'];
        var guest_info = 'nick,mail,link'.split(',').filter(function(item){
          return GUEST_INFO.indexOf(item) > -1
        });
        new Valine({
            el: '#comments',
            notify: 'true' == 'true',
            verify: 'false' == 'true',
            appId: "4DjAfnIwjxGfITAYl8eVX5Pe-gzGzoHsz",
            appKey: "ss62qxcFEjf5opJ4Ii5xI2zn",
            avatar: "mm",
            placeholder: "欢迎交流",
            guest_info: guest_info.length == 0 ? GUEST_INFO : guest_info,
            pageSize: "10"
        })
    </script>
    <!-- Valine Comments end -->







</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        Thanks~
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/wechat.jpg" data-alipay="/img/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Cstsinghua &copy; 2016 - 2018</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://cstsinghua.github.io/2018/07/19/Appium启动和日志分析/&title=《Appium启动和日志分析》 — Atypical programmer&pic=https://cstsinghua.github.io/img/logo.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://cstsinghua.github.io/2018/07/19/Appium启动和日志分析/&title=《Appium启动和日志分析》 — Atypical programmer&source=写给典型的程序员" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://cstsinghua.github.io/2018/07/19/Appium启动和日志分析/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Appium启动和日志分析》 — Atypical programmer&url=https://cstsinghua.github.io/2018/07/19/Appium启动和日志分析/&via=https://cstsinghua.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://cstsinghua.github.io/2018/07/19/Appium启动和日志分析/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://cstsinghua.github.io/2018/07/19/Appium启动和日志分析/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


lazyScripts.push('//s95.cnzz.com/z_stat.php?id=1259817891&web_id=1259817891')

</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
